version: 2.1

executors:
  docker_executor:
    docker:
      - image: cimg/node:22.17

jobs:
  build_push_deploy:
    executor: docker_executor

    steps:

      - checkout

      - run:
          name: Clean deploy folder
          command: rm -rf deploy && mkdir deploy

      #Activar docker remoto
      - setup_remote_docker:
          docker_layer_caching: false

      - run:
          name: Ensure git repo is fully fetched
          command: |
            git fetch --unshallow || true
            git pull origin main

      # Install dependencies and run tests
      - run:
          name: Install Node + Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y nodejs npm
            npm ci || npm install

      # SAST - npm audit
          name: SAST - npm audit
          command: |
            npm audit --json > npm-audit.json || true
            npx npm-audit-html -i npm-audit.json -o npm-audit-report.html || true


      # SAST - ESLint Security
      - run:
          name: SAST - ESLint Security Scan
          command: |
            npx eslint . --ext .js -f html -o eslint-security-report.html || true

      # Guardar artefactos SAST
      - store_artifacts:
          path: npm-audit-report.html
          destination: sast/npm-audit-report.html

      - store_artifacts:
          path: eslint-security-report.html
          destination: sast/eslint-security-report.html

      - run:
          name: Run tests and ensure coverage/reports exist
          command: |
            echo "Running tests..."
            npm run test || echo "Tests failed — continuing pipeline"

            echo "Generating report..."
            npm run report || echo "Report generation failed — continuing pipeline"

            echo "Ensuring coverage and reports directories exist..."
            mkdir -p coverage
            mkdir -p reports

      - run:
          name: Normalize vars to lowercase
          command: |
            GITHUB_USER_LC=$(echo "$GITHUB_USER" | tr '[:upper:]' '[:lower:]')
            echo "export GITHUB_USER_LC=$GITHUB_USER_LC" >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Build Docker image
          command: |
            IMAGE_TAG=$(echo $CIRCLE_SHA1 | cut -c1-7)
            echo "export IMAGE_TAG=$IMAGE_TAG" >> $BASH_ENV
            source $BASH_ENV

            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG .
            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:latest .

      - run:
          name: Login to GHCR
          command: |
            echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USER --password-stdin

      - run:
          name: Push image to GHCR
          command: |
            docker push ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG
            docker push ghcr.io/${GITHUB_USER_LC}/contador:latest

      - run:
          name: Save main content before switching branch
          command: |
            mkdir main_copy
            cp -R index.html style.css report.html script.js logic.js main_copy/

      # Actualizar la rama donde ArgoCD mira la imagen
      - run:
          name: Update ArgoCD manifest with new image tag
          command: |
            git fetch origin
            git checkout -B argo-deploy origin/argo-deploy || git checkout -B argo-deploy

            echo "Actualizando manifest de ArgoCD con imagen: $IMAGE_TAG"

            # Ajusta la ruta si tu YAML está en otro lugar
            sed -i "s|\(ghcr.io/${GITHUB_USER_LC}/contador:\).*|\1${IMAGE_TAG}|" k8s/deployment.yaml

            git config user.name "EmilioAMVs"
            git config user.email "emiliocabrera321@outlook.com"

            git add k8s/deployment.yaml
            git commit -m "Update image tag to ${IMAGE_TAG} [ci skip]" || echo "No changes to commit"
            git push origin argo-deploy

      - run:
          name: Build deploy folder with updated files
          command: |
            cp main_copy/index.html deploy/
            cp main_copy/style.css deploy/
            cp main_copy/report.html deploy/
            cp main_copy/script.js deploy/
            cp main_copy/logic.js deploy/

      - run:
          name: Deploy to GitHub Pages (via HTTPS + Token)
          command: |
            cd deploy
            git init
            git checkout -B $DEPLOY_BRANCH
            git config user.name "EmilioAMVs"
            git config user.email "emiliocabrera321@outlook.com"
            git add .
            git commit -m "Deploy from CircleCI"

            git remote add origin https://${GITHUB_TOKEN}@github.com/${GITHUB_USER}/${GITHUB_REPO}.git
            git push -f origin $DEPLOY_BRANCH


      # DAST - OWASP ZAP
      - run:
          name: DAST - OWASP ZAP Baseline Scan
          command: |
            docker run -v "$PWD:/zap/wrk/:rw" -t ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py \
              -t https://emilioamvs.github.io/Contador-Clicks-Pipeline-Jenkins/ \
              -r zap-report.html || true

      # Guardar artefactos DAST
      - store_artifacts:
          path: zap-report.html
          destination: dast/zap-report.html

      - run:
          name: Send notification to Power Automate
          when: always  
          command: |
            STATUS="SUCCESS"
            if [ "$CIRCLE_JOB" != "build_push_deploy" ]; then
              STATUS="FAILED"
            fi

            SUMMARY_FILE="reports/summary.txt"
            if [ -f "$SUMMARY_FILE" ]; then
              SUMMARY_TEXT=$(cat "$SUMMARY_FILE")
            else
              SUMMARY_TEXT="No summary file found."
            fi

            PAYLOAD=$(jq -n \
              --arg pipelineName "${CIRCLE_PROJECT_REPONAME}" \
              --arg status "$STATUS" \
              --arg summary "$SUMMARY_TEXT" \
              '{pipelineName: $pipelineName, status: $status, summary: $summary}')

            curl -X POST -H "Content-Type: application/json" \
              -d "$PAYLOAD" "$POWER_AUTOMATE_URL"

workflows:
  version: 2
  build-deploy-workflow:
    jobs:
      - build_push_deploy
