version: 2.1

executors:
  docker_executor:
    docker:
      - image: cimg/node:22.17

jobs:
  build_push_deploy:
    executor: docker_executor

    steps:

      - run:
          name: Clean workspace
          command: |
            git reset --hard
            git clean -fdx

      - checkout

      - run:
          name: Fetch latest changes unshallow
          command: |
            git fetch --unshallow || true
            git pull origin main

      - setup_remote_docker:
          docker_layer_caching: false

      # Install dependencies and run tests
      - run:
          name: Install Node + Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y nodejs npm
            npm ci || npm install

      - run:
          name: Run tests and ensure coverage/reports exist
          command: |
            echo "Running tests..."
            npm run test || echo "Tests failed — continuing pipeline"

            echo "Generating report..."
            npm run report || echo "Report generation failed — continuing pipeline"

            echo "Ensuring coverage and reports directories exist..."
            mkdir -p coverage
            mkdir -p reports

      - run:
          name: Normalize vars to lowercase
          command: |
            GITHUB_USER_LC=$(echo "$GITHUB_USER" | tr '[:upper:]' '[:lower:]')
            echo "export GITHUB_USER_LC=$GITHUB_USER_LC" >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Build Docker image
          command: |
            IMAGE_TAG=$(echo $CIRCLE_SHA1 | cut -c1-7)
            echo "export IMAGE_TAG=$IMAGE_TAG" >> $BASH_ENV
            source $BASH_ENV

            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG .
            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:latest .

      - run:
          name: Login to GHCR
          command: |
            echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USER --password-stdin

      - run:
          name: Push image to GHCR
          command: |
            docker push ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG
            docker push ghcr.io/${GITHUB_USER_LC}/contador:latest

      # Actualizar la rama donde ArgoCD mira la imagen
      - run:
          name: Update ArgoCD manifest with new image tag
          command: |
            git fetch origin
            git checkout -B argo-deploy origin/argo-deploy || git checkout -B argo-deploy

            echo "Actualizando manifest de ArgoCD con imagen: $IMAGE_TAG"

            # Ajusta la ruta si tu YAML está en otro lugar
            sed -i "s|\(ghcr.io/${GITHUB_USER_LC}/contador:\).*|\1${IMAGE_TAG}|" k8s/deployment.yaml

            git config user.name "EmilioAMVs"
            git config user.email "emiliocabrera321@outlook.com"

            git add k8s/deployment.yaml
            git commit -m "Update image tag to ${IMAGE_TAG} [ci skip]" || echo "No changes to commit"
            git push origin argo-deploy

      - run:
          name: Clean deploy folder
          command: |
            rm -rf deploy
            mkdir -p deploy

      - run:
          name: Build deploy folder with updated files
          command: |
            cp index.html deploy/
            cp style.css deploy/
            cp report.html deploy/
            cp script.js deploy/
            cp logic.js deploy/
            cp -r coverage deploy/coverage || true
            cp -r reports deploy/reports || true

      - run:
          name: Deploy to GitHub Pages (via HTTPS + Token)
          command: |
            cd deploy
            git init
            git checkout -B $DEPLOY_BRANCH
            git config user.name "EmilioAMVs"
            git config user.email "emiliocabrera321@outlook.com"
            git add .
            git commit -m "Deploy from CircleCI"

            git remote add origin https://${GITHUB_TOKEN}@github.com/${GITHUB_USER}/${GITHUB_REPO}.git
            git push -f origin $DEPLOY_BRANCH

      - run:
          name: Send notification to Power Automate
          when: always
          command: |
            STATUS="SUCCESS"
            if [ "$CIRCLE_JOB" != "build_push_deploy" ]; then
              STATUS="FAILED"
            fi

            SUMMARY_FILE="reports/summary.txt"
            if [ -f "$SUMMARY_FILE" ]; then
              SUMMARY_TEXT=$(cat "$SUMMARY_FILE")
            else
              SUMMARY_TEXT="No summary file found."
            fi

            PAYLOAD=$(jq -n \
              --arg pipelineName "${CIRCLE_PROJECT_REPONAME}" \
              --arg status "$STATUS" \
              --arg summary "$SUMMARY_TEXT" \
              '{pipelineName: $pipelineName, status: $status, summary: $summary}')

            curl -X POST -H "Content-Type: application/json" \
              -d "$PAYLOAD" "$POWER_AUTOMATE_URL"

workflows:
  version: 2
  build-deploy-workflow:
    jobs:
      - build_push_deploy
