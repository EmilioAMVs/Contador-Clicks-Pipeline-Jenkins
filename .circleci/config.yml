version: 2.1

executors:
  docker_executor:
    docker:
      - image: cimg/base:stable   # Necesitamos Docker CLI aquÃ­

jobs:
  build_push_deploy:
    executor: docker_executor

    steps:
      - checkout

      - setup_remote_docker:
            docker_layer_caching: false
      - run:
          name: Normalize vars to lowercase
          command: |
            GITHUB_USER_LC=$(echo "$GITHUB_USER" | tr '[:upper:]' '[:lower:]')
            echo "export GITHUB_USER_LC=$GITHUB_USER_LC" >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Build Docker image
          command: |
            IMAGE_TAG=$(echo $CIRCLE_SHA1 | cut -c1-7)
            echo "export IMAGE_TAG=$IMAGE_TAG" >> $BASH_ENV
            source $BASH_ENV

            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG .
            docker build -t ghcr.io/${GITHUB_USER_LC}/contador:latest .

      - run:
          name: Login to GHCR
          command: |
            echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USER --password-stdin

      - run:
          name: Push image to GHCR
          command: |
            docker push ghcr.io/${GITHUB_USER_LC}/contador:$IMAGE_TAG
            docker push ghcr.io/${GITHUB_USER_LC}/contador:latest

      - run:
          name: Update Kubernetes Deployment manifest
          command: |
            sed -i "s|image: ghcr.io/.*/contador:.*|image: ghcr.io/${GITHUB_USER}/contador:$IMAGE_TAG|" k8s/deployment.yaml

      - run:
          name: Commit manifest update (Triggers ArgoCD sync)
          command: |
            git config user.name "CircleCI Bot"
            git config user.email "ci-bot@circleci.com"

            git add k8s/deployment.yaml
            git commit -m "Deploy image $IMAGE_TAG via CircleCI"
            git push https://${GITHUB_TOKEN}@github.com/${GITHUB_USER}/${GITHUB_REPO}.git HEAD

workflows:
  version: 2
  build-deploy-workflow:
    jobs:
      - build_push_deploy
